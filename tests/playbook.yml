---
- name: Create bootstrap VM
  hosts: localhost
  gather_facts: false

  vars:
    enable_kvm: true

  tasks:
    - name: Ensure required directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0o755"
      loop:
        - keys
        - cloud-init

    - name: Generate a ssh key
      community.crypto.openssh_keypair:
        path: keys/id_rsa
      register: _key

    - name: Generate cloud-init user config
      ansible.builtin.copy:
        content: |
          #cloud-config
          disable: true
          hostname: homelab
          fqdn: homelab
          manage_etc_hosts: true
          users:
            - name: root
              ssh-authorized-keys:
                - {{ _key.public_key }}
          ssh_pwauth: false
          disable_root: false
        dest: cloud-init/user-data
        mode: "0o644"

    - name: Generate cloud-init iso
      ansible.builtin.command:
        cmd: cloud-localds cloud-init/cloud-init.iso cloud-init/user-data
        creates: cloud-init/cloud-init.iso"

    - name: Copy the pre-downloaded image
      ansible.builtin.copy:
        src: original-debian-13.qcow2
        dest: bootstrap.qcow2
        mode: "0o644"
        force: false

    - name: Start the VM
      community.libvirt.virt_install:
        name: test
        memory: 1024
        vcpus: 1
        boot: uefi,firmware.feature0.name=secure-boot,firmware.feature0.enabled=no
        cdrom: cloud-init/cloud-init.iso
        disks:
          - path: bootstrap.qcow2
        import: true
        networks:
          - bridge: virbr0
            model:
              type: virtio
        osinfo:
          name: debian13
        transient: false
        uri: qemu:///session
        virt_type: "{{ enable_kvm | ternary('kvm', omit) }}"

    - name: Gather info about VM
      community.libvirt.virt:
        command: get_interfaces
        name: test
        uri: qemu:///session
      register: _interfaces

    - name: Gather facts about networks
      community.libvirt.virt_net:
        command: facts
      until: >-
        _networks.ansible_facts.ansible_libvirt_networks.default.dhcp_leases
        | selectattr('mac', 'equalto', _interfaces.network_interfaces.interface_1.mac)
        | length == 1
      retries: 120
      delay: 5
      register: _networks

    - name: Find the ip address
      ansible.builtin.set_fact:
        addr: >-
          {{
            ansible_facts.libvirt_networks.default.dhcp_leases
            | selectattr('mac', 'equalto', _interfaces.network_interfaces.interface_1.mac)
            | map(attribute='ipaddr')
            | first
          }}

    - name: Wait for the VM to be online
      ansible.builtin.wait_for:
        host: "{{ addr }}"
        port: 22
        search_regex: OpenSSH

    - name: Add the vm to the transient inventory
      ansible.builtin.add_host:
        name: "{{ addr }}"
        groups: vms
        ansible_user: root
        ansible_ssh_private_key_file: keys/id_rsa
        ansible_ssh_host_key_checking: false

- name: Validate the VM works
  hosts: vms
  gather_facts: false

  tasks:
    - name: Ensure we can connect to the host
      ansible.builtin.wait_for_connection:

    - name: Test the host can access the internet
      ansible.builtin.wait_for:
        host: google.com
        port: 443

- name: Cleanup
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Stop the VM gracefully
      community.libvirt.virt:
        name: test
        state: shutdown
        uri: qemu:///session

    - name: Wait for the VM to be off
      community.libvirt.virt:
        name: test
        command: status
        uri: qemu:///session
      until: _vm_stat.status == "shutdown"
      retries: 30
      delay: 3
      register: _vm_stat

    - name: Destroy the Virtual Machine
      community.libvirt.virt:
        name: test
        command: undefine
        force: true
        uri: qemu:///session
